<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>部署kubernetes-dashboard_apiserver方式</title>
    <url>/2020/03/15/deploy-kubernetes-dashboard_apiserver/</url>
    <content><![CDATA[<p>部署kubernetes-dashboard的方式，也可以理解为归纳为访问kubernetes服务的方式，目前有下面4种方式：</p>
<ol>
<li><code>kubectl proxy</code>  （官方推荐，最简单，但必须在master节点上有图形界面）</li>
<li>通过集群APISERVER访问（适用于集群多节点，推荐）</li>
<li>NodePort端口映射（暴露master节点端口号，安全性不好，只适用于开发环境或单节点环境，不推荐）</li>
<li>ingress （通过反向代理集成，还没实践过）</li>
</ol>
<p>这里介绍第二种，通过API访问方式来部署</p>
<a id="more"></a>

<p>前提：kubernetes基本组件已正确安装<br><code># kubectl get cs</code></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>:<span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><code>$ kubectl get nodes -o wide</code></p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">master1   Ready    master   <span class="number">7</span>h15m   v1<span class="number">.15</span><span class="number">.10</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.6</span>    &lt;none&gt;        CentOS Linux <span class="number">7</span> (Core)   <span class="number">3.10</span><span class="number">.0</span><span class="number">-862.</span>el7.x86_64   docker:<span class="comment">//18.6.3</span></span><br><span class="line">worker1   Ready    &lt;none&gt;   <span class="number">5</span>h35m   v1<span class="number">.15</span><span class="number">.10</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.7</span>    &lt;none&gt;        CentOS Linux <span class="number">7</span> (Core)   <span class="number">3.10</span><span class="number">.0</span><span class="number">-862.</span>el7.x86_64   docker:<span class="comment">//18.6.3</span></span><br><span class="line">worker2   Ready    &lt;none&gt;   <span class="number">3</span>h42m   v1<span class="number">.15</span><span class="number">.10</span>   <span class="number">192.168</span><span class="number">.10</span><span class="number">.8</span>   &lt;none&gt;        CentOS Linux <span class="number">7</span> (Core)   <span class="number">3.10</span><span class="number">.0</span><span class="number">-862.</span>el7.x86_64   docker:<span class="comment">//18.6.3</span></span><br></pre></td></tr></table></figure>

<p>kubernetes-dashboard.yaml（官方链接已失效，<br><a href="https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml）文件进行了如下修改：">https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml）文件进行了如下修改：</a></p>
<ol>
<li>本地找不到镜像时才从网上拉取（imagePullPolicy: IfNotPresent ）</li>
<li>登录token过期时间改为28800分钟 （- –token-ttl=28800 ）</li>
</ol>
<h4 id="拉取dashboard镜像"><a href="#拉取dashboard镜像" class="headerlink" title="拉取dashboard镜像"></a>拉取dashboard镜像</h4><p>以下操作必须在所有节点上执行<br>拉取镜像<br><code># docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1</code><br>链接镜像<br><code># docker tag mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</code></p>
<h4 id="部署dashboard插件"><a href="#部署dashboard插件" class="headerlink" title="部署dashboard插件"></a>部署dashboard插件</h4><p>以下操作只需在master节点上执行</p>
<p><code># kubectl apply -f  kubernetes-dashboard.yaml</code></p>
<h4 id="创建管理用户"><a href="#创建管理用户" class="headerlink" title="创建管理用户"></a>创建管理用户</h4><h5 id="创建服务账号"><a href="#创建服务账号" class="headerlink" title="创建服务账号"></a>创建服务账号</h5><p>admin-user.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建服务账号</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为账号绑定角色</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<p><code># kubectl create -f admin-user.yaml</code></p>
<h4 id="证书操作"><a href="#证书操作" class="headerlink" title="证书操作"></a>证书操作</h4><p>生成crt证书文件<br><code># grep &#39;client-certificate-data&#39; /etc/kubernetes/admin.conf | head -n 1 | awk &#39;{print $2}&#39; | base64 -d &gt;&gt; kubecfg.crt</code><br>生成key公钥文件<br><code># grep &#39;client-key-data&#39; /etc/kubernetes/admin.conf | head -n 1 | awk &#39;{print $2}&#39; | base64 -d &gt;&gt; kubecfg.key</code><br>生成p12证书文件，用于稍后导入到客户端chrome浏览器（密码为空）<br><code>openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name &quot;kubernetes-client&quot;</code></p>
<h4 id="获取登录秘钥"><a href="#获取登录秘钥" class="headerlink" title="获取登录秘钥"></a>获取登录秘钥</h4><p>上面创建完用户后，会自动生成秘钥<br><code>$ kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Name:</span>         <span class="string">admin-user-token-77fw4</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">kube-system</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:  kubernetes.io/service-account.name:</span> <span class="string">admin-user</span></span><br><span class="line">              <span class="attr">kubernetes.io/service-account.uid:</span> <span class="string">ae6bbbc1-e805-48c4-a3ea-c83c3fcc67fe</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Type:</span>  <span class="string">kubernetes.io/service-account-token</span></span><br><span class="line"></span><br><span class="line"><span class="string">Data</span></span><br><span class="line"><span class="string">====</span></span><br><span class="line"><span class="attr">ca.crt:</span>     <span class="number">1025</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">namespace:</span>  <span class="number">11</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">token:</span>      <span class="string">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTc3Znc0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhZTZiYmJjMS1lODA1LTQ4YzQtYTNlYS1jODNjM2ZjYzY3ZmUiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.IKm_IB-B94ng_EOVHCMFMIEBSfnpFrIu5IoA07A5MWptIJO-fvLW-Y6mg4igJlJGAOym_uGYpwTo4xN0upsZYgDfFeNxjo84KW_qQPfDOy04mlcDK3lVSka0FtyA5FOJtWYWmTUrhqarFutXRsGfujeP0ERB2ilBdZAg-6TM7G15aKQ24ZmWtQfhiugS4UvU9O7Ho5Z4FF9uu_0CbNKR9NmWN6MmcGzD47_qATR-wk8kIOXKIaBW5a32UMYxTAhkxxMf_o2djwVr3Sg47Q2JRi87FprJoYu-QlUXPIVaZ8tfurmyNFAgVrL8kAiC1qJGujrTICyCMt8YKaY8DSoWmw</span></span><br></pre></td></tr></table></figure>
<p>token就是上面 token字段的值</p>
<h4 id="登录kubernetes-dashboard"><a href="#登录kubernetes-dashboard" class="headerlink" title="登录kubernetes-dashboard"></a>登录kubernetes-dashboard</h4><p>查看集群的API端口号<br><code>$ kubectl cluster-info</code></p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">Kubernetes master <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">6443</span></span><br><span class="line">KubeDNS <span class="keyword">is</span> running at http<span class="variable">s:</span>//<span class="number">192.168</span>.<span class="number">0.6</span>:<span class="number">6443</span>/api/v1/namespaces/kube-<span class="built_in">system</span>/services/kube-dn<span class="variable">s:dns</span>/proxy</span><br><span class="line"></span><br><span class="line">To further <span class="keyword">debug</span> <span class="built_in">and</span> diagnose cluster problems, use <span class="string">'kubectl cluster-info dump'</span>.</span><br></pre></td></tr></table></figure>


<p>导入kubecfg.p12文件到浏览器, 打开浏览器，输入地址（<br><a href="https://192.168.0.6:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy），选择“令牌”复制token到文本框，点击“登录”即可">https://192.168.0.6:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy），选择“令牌”复制token到文本框，点击“登录”即可</a></p>
<p><img src="http://q785iasco.bkt.clouddn.com/kubernetes/dashboard/deploy_API_01.png" alt><br><img src="http://q785iasco.bkt.clouddn.com/kubernetes/dashboard/deploy_API_02.png" alt="复制token到文本框"><br><img src="http://q785iasco.bkt.clouddn.com/kubernetes/dashboard/deploy_API_03.png" alt></p>
<h4 id="kubernetes-dashboard-yaml"><a href="#kubernetes-dashboard-yaml" class="headerlink" title="kubernetes-dashboard.yaml"></a>kubernetes-dashboard.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuration to deploy release version of the Dashboard UI compatible with</span></span><br><span class="line"><span class="comment"># Kubernetes 1.8.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example usage: kubectl create -f &lt;this_file&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------- Dashboard Secret ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Service Account ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Role &amp; Role Binding ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to create 'kubernetes-dashboard-key-holder' secret.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["create"]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to create 'kubernetes-dashboard-settings' config map.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["create"]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["kubernetes-dashboard-key-holder",</span> <span class="string">"kubernetes-dashboard-certs"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["kubernetes-dashboard-settings"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get metrics from heapster.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["services"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["heapster"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["proxy"]</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["services/proxy"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["heapster",</span> <span class="string">"http:heapster:"</span><span class="string">,</span> <span class="string">"https:heapster:"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get"]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Deployment ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>     <span class="comment"># 本地找不到镜像时才从网上拉取</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--token-ttl=28800</span>    <span class="comment"># 登录token过期时间改为28800分钟</span></span><br><span class="line">          <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class="line">          <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">          <span class="comment"># to it. Uncomment only if the default does not work.</span></span><br><span class="line">          <span class="comment"># - --apiserver-host=http://my-address:port</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">          <span class="comment"># Create on-disk volume to store exec logs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Service ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>

<h4 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h4><p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a><br><a href="https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/">https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/</a><br><a href="https://www.jianshu.com/p/3fdcfbeb65d1">https://www.jianshu.com/p/3fdcfbeb65d1</a></p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>部署kubernetes-dashboard_NodePort方式</title>
    <url>/2020/03/15/deploy-kubernetes-dashboard_nodeport/</url>
    <content><![CDATA[<p>部署kubernetes-dashboard的方式，也可以理解为归纳为访问kubernetes服务的方式，目前有下面4种方式：</p>
<ol>
<li><code>kubectl proxy</code>  （官方推荐，最简单，但必须在master节点上有图形界面）</li>
<li>通过集群APISERVER访问（适用于集群多节点，推荐）</li>
<li>NodePort端口映射（暴露master节点端口号，安全性不好，只适用于开发环境或单节点环境，不推荐）</li>
<li>ingress （通过反向代理集成，还没实践过）</li>
</ol>
<p>这里介绍第三种，通过NodePort端口映射方式来部署</p>
<a id="more"></a>

<p>前提：kubernetes基本组件已正确安装<br><code># kubectl get cs</code></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>

<p><code># kubectl get nodes -o wide</code></p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">NAME         STATUS   ROLES    AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME</span><br><span class="line">centos75<span class="number">-2</span>   Ready    master   <span class="number">4</span>h48m   v1<span class="number">.13</span><span class="number">.12</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.7</span>   &lt;none&gt;        CentOS Linux <span class="number">7</span> (Core)   <span class="number">3.10</span><span class="number">.0</span><span class="number">-862.</span>el7.x86_64   docker:<span class="comment">//18.6.3</span></span><br></pre></td></tr></table></figure>

<p>kubernetes-dashboard.yaml（官方链接已失效，<br><a href="https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml）文件进行了如下修改：">https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml）文件进行了如下修改：</a></p>
<ol>
<li>不用官方默认证书（只能在Firefox浏览器上能打开），改用自签名证书</li>
<li>本地找不到镜像时才从网上拉取（imagePullPolicy: IfNotPresent ）</li>
<li>登录token过期时间改为28800分钟 （- –token-ttl=28800 ）</li>
<li>NodePort端口设置（type: NodePort     nodePort: 32532 ）</li>
</ol>
<h4 id="拉取dashboard镜像"><a href="#拉取dashboard镜像" class="headerlink" title="拉取dashboard镜像"></a>拉取dashboard镜像</h4><p>拉取镜像<br><code># docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1</code><br>链接镜像<br><code># docker tag mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</code></p>
<h4 id="生成自签名证书"><a href="#生成自签名证书" class="headerlink" title="生成自签名证书"></a>生成自签名证书</h4><p>生成证书请求的key<br><code># openssl genrsa -out dashboard.key 2048</code></p>
<p>生成证书请求<br><code># openssl req -new -out dashboard.csr -key dashboard.key -subj &#39;/CN=192.168.0.7&#39;</code></p>
<p>生成自签名证书，过期时间为3650天<br><code># openssl x509 -days 3650 -req -in dashboard.csr -signkey dashboard.key -out dashboard.crt</code></p>
<h4 id="部署dashboard插件"><a href="#部署dashboard插件" class="headerlink" title="部署dashboard插件"></a>部署dashboard插件</h4><p><code># kubectl apply -f  kubernetes-dashboard.yaml</code></p>
<p>确认NodePort端口已经开放<br><code># kubectl --namespace=kube-system  get service kubernetes-dashboard</code></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">NAME                  <span class="built_in"> TYPE </span>      CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.109.196.25   &lt;none&gt;        443:32532/TCP   5h5m</span><br></pre></td></tr></table></figure>

<p>如果没开放，可以重新编辑（<code># kubectl --namespace=kube-system edit service kubernetes-dashboard</code>）</p>
<h4 id="创建证书"><a href="#创建证书" class="headerlink" title="创建证书"></a>创建证书</h4><p><code># kubectl create secret generic kubernetes-dashboard-certs --from-file=dashboard.key --from-file=dashboard.crt -n kube-system</code></p>
<p>查看dashaboard的pod是否处于running状态<br><code># kubectl get pods --all-namespaces</code></p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">kube-system   kubernetes-dashboard<span class="number">-5</span>b765cfb57-ts9d8   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">4</span>h18m</span><br></pre></td></tr></table></figure>
<p>如果不是running状态，可以删掉pod (<code>kubectl delete pod -n kubernetes-dashboard &lt;pod名&gt;</code> )重新部署dashboard插件</p>
<p>排错命令<br><code># kubectl describe pod kubernetes-dashboard-5b765cfb57-vmlw6 --namespace=kube-system</code></p>
<h4 id="创建管理用户"><a href="#创建管理用户" class="headerlink" title="创建管理用户"></a>创建管理用户</h4><h5 id="创建服务账号"><a href="#创建服务账号" class="headerlink" title="创建服务账号"></a>创建服务账号</h5><p>admin-user.yaml</p>
<figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> admin-user</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br></pre></td></tr></table></figure>

<p><code>kubectl create -f admin-user.yaml</code></p>
<h5 id="为用户绑定角色"><a href="#为用户绑定角色" class="headerlink" title="为用户绑定角色"></a>为用户绑定角色</h5><p>admin-user-role-binding.yaml</p>
<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="attribute">kind</span>: ClusterRoleBinding</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: admin-user</span><br><span class="line"><span class="attribute">roleRef</span>:</span><br><span class="line">  <span class="attribute">apiGroup</span>: rbac.authorization.k8s.io</span><br><span class="line">  <span class="attribute">kind</span>: ClusterRole</span><br><span class="line">  <span class="attribute">name</span>: cluster-admin</span><br><span class="line"><span class="attribute">subjects</span>:</span><br><span class="line">- <span class="attribute">kind</span>: ServiceAccount</span><br><span class="line">  <span class="attribute">name</span>: admin-user</span><br><span class="line">  <span class="attribute">namespace</span>: kube-system</span><br></pre></td></tr></table></figure>

<p><code># kubectl create -f admin-user.yaml</code></p>
<p>也可以把两个yaml文件合成一个，中间用”—“隔开,用一个”kubectl create”语句即可</p>
<h4 id="获取登录秘钥"><a href="#获取登录秘钥" class="headerlink" title="获取登录秘钥"></a>获取登录秘钥</h4><p>上面创建完用户后，会自动生成秘钥<br>`# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk ‘{print $1}’)</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Name:</span>         <span class="string">admin-user-token-44dt9</span></span><br><span class="line"><span class="attr">Namespace:</span>    <span class="string">kube-system</span></span><br><span class="line"><span class="attr">Labels:</span>       <span class="string">&lt;none&gt;</span></span><br><span class="line"><span class="attr">Annotations:  kubernetes.io/service-account.name:</span> <span class="string">admin-user</span></span><br><span class="line">              <span class="attr">kubernetes.io/service-account.uid:</span> <span class="string">eb2bb262-5498-11ea-8b9d-080027720348</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Type:</span>  <span class="string">kubernetes.io/service-account-token</span></span><br><span class="line"></span><br><span class="line"><span class="string">Data</span></span><br><span class="line"><span class="string">====</span></span><br><span class="line"><span class="attr">ca.crt:</span>     <span class="number">1025</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">namespace:</span>  <span class="number">11</span> <span class="string">bytes</span></span><br><span class="line"><span class="attr">token:</span>      <span class="string">eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTQ0ZHQ5Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJlYjJiYjI2Mi01NDk4LTExZWEtOGI5ZC0wODAwMjc3MjAzNDgiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.A8CTyYWgBbWTkbOLBzpdw0ConJ6mjBOn-OSGeVL0GlUWWEnfHq8HvII4m8s7sILDKVIx3YLwLpIw8xgpIl1OhrHcTJ-Z28dnxEL-5AWNMhZUErp47gYf5Ij4oq7Up0eiNE9UwXgnPEjWsiKuCdcW8k_537Ns7MKgToXOVB_uA8t89h5ozznF8EWIavOC_ZH238OpOmyPbeI7zoitZhB0jhY1Dzo05QqGL3teklv-GEcZdo-_5Z90jIwqFGEH8b3n4Q-XI5ZZEljC0mVSd4rdse8WeLV7DR0WTUfGS7noBETmeiO31MBBCbRAf-5JG01jkiaZ8HCkzo4Ik1_fcGgX9g</span></span><br></pre></td></tr></table></figure>
<p>token就是上面 token字段的值</p>
<h4 id="登录kubernetes-dashboard"><a href="#登录kubernetes-dashboard" class="headerlink" title="登录kubernetes-dashboard"></a>登录kubernetes-dashboard</h4><p>打开浏览器，输入地址（<a href="https://192.168.0.7:32532/），选择“令牌”复制token到文本框，点击“登录”即可">https://192.168.0.7:32532/），选择“令牌”复制token到文本框，点击“登录”即可</a></p>
<p><img src="http://q785iasco.bkt.clouddn.com/kubernetes/dashboard/deploy_NodePort_01.png" alt="复制token到文本框"><br><img src="http://q785iasco.bkt.clouddn.com/kubernetes/dashboard/deploy_NodePort_02.png" alt></p>
<h4 id="kubernetes-dashboard-yaml"><a href="#kubernetes-dashboard-yaml" class="headerlink" title="kubernetes-dashboard.yaml"></a>kubernetes-dashboard.yaml</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuration to deploy release version of the Dashboard UI compatible with</span></span><br><span class="line"><span class="comment"># Kubernetes 1.8.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example usage: kubectl create -f &lt;this_file&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------- Dashboard Secret ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#apiVersion: v1    # 不使用官方默认证书(只能在Firefox浏览器上打开）</span></span><br><span class="line"><span class="comment">#kind: Secret</span></span><br><span class="line"><span class="comment">#metadata:</span></span><br><span class="line"><span class="comment">#  labels:</span></span><br><span class="line"><span class="comment">#    k8s-app: kubernetes-dashboard</span></span><br><span class="line"><span class="comment">#  name: kubernetes-dashboard-certs</span></span><br><span class="line"><span class="comment">#  namespace: kube-system</span></span><br><span class="line"><span class="comment">#type: Opaque</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Service Account ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Role &amp; Role Binding ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to create 'kubernetes-dashboard-key-holder' secret.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["create"]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to create 'kubernetes-dashboard-settings' config map.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["create"]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["kubernetes-dashboard-key-holder",</span> <span class="string">"kubernetes-dashboard-certs"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["configmaps"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["kubernetes-dashboard-settings"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line">  <span class="comment"># Allow Dashboard to get metrics from heapster.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["services"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["heapster"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["proxy"]</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["services/proxy"]</span></span><br><span class="line">  <span class="attr">resourceNames:</span> <span class="string">["heapster",</span> <span class="string">"http:heapster:"</span><span class="string">,</span> <span class="string">"https:heapster:"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get"]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Deployment ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>     <span class="comment"># 本地找不到镜像时才从网上拉取</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--auto-generate-certificates</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--token-ttl=28800</span>    <span class="comment"># 登录token过期时间改为28800分钟</span></span><br><span class="line">          <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class="line">          <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">          <span class="comment"># to it. Uncomment only if the default does not work.</span></span><br><span class="line">          <span class="comment"># - --apiserver-host=http://my-address:port</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/certs</span></span><br><span class="line">          <span class="comment"># Create on-disk volume to store exec logs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8443</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">kubernetes-dashboard-certs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-volume</span></span><br><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Service ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>  <span class="comment"># NodePort, 不用注释 </span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">32532</span>  <span class="comment"># NodePort端口号 </span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>

<h4 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h4><p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a><br><a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md</a><br><a href="https://www.cnblogs.com/life-of-coding/p/11794993.html">https://www.cnblogs.com/life-of-coding/p/11794993.html</a></p>
]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
        <tag>dashboard</tag>
      </tags>
  </entry>
  <entry>
    <title>记一次坑爹的hexo排错经历</title>
    <url>/2020/03/21/a-hexo-error-config/</url>
    <content><![CDATA[<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>最近换上hexo的next主题后，各种折腾，包括一些第三方配置. 对扩展和配置文件的改动很大。然后就杯具了。</p>
<p>根据报错信息无从下手，网上搜索也没线索，直接表现就是每次用<code>hexo g</code>编译后，public下生成的文章都是0字节。即编译失败。 </p>
<a id="more"></a>
<h4 id="排错思路"><a href="#排错思路" class="headerlink" title="排错思路"></a>排错思路</h4><p>简单讲下当时怎么解决的</p>
<h5 id="检查文章格式"><a href="#检查文章格式" class="headerlink" title="检查文章格式"></a>检查文章格式</h5><p>当时的思路是这样的：是不是新增的文章markdown格式有问题呢？于是便把<code>_post</code>目录下的文章先移出来，写了个<code>test.md</code>, 用最简单的格式，再重新编译。问题依旧，排除。</p>
<h5 id="重新安装hexo和next主题"><a href="#重新安装hexo和next主题" class="headerlink" title="重新安装hexo和next主题"></a>重新安装hexo和next主题</h5><p>重新建了个目录，再来一套。并把旧的主配置文件和主题配置文件复制进来, 还有问题。 </p>
<h5 id="用默认的配置文件"><a href="#用默认的配置文件" class="headerlink" title="用默认的配置文件"></a>用默认的配置文件</h5><p>恢复默认配置文件，包括主配置文件（站点目录下）, 主题配置文件（主题目录下）, 这下却好了.<br>这里基本确定是配置文件问题了，把旧主配置文件再复制进来，还可以。</p>
<p>原来，是主题配置文件中有个值配置不对，看来有必要对hexo的配置文件上版本管理了。</p>
]]></content>
      <categories>
        <category>debug</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2021/12/25/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<a id="more"></a>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>nginx拒绝恶意域名解析设置</title>
    <url>/2020/03/21/nginx-reject-malicious-resolv/</url>
    <content><![CDATA[<p>前段时间，nginx的访问日志里有很多<code>/otsmobile/app/mgs/mgw.htm?operationType</code> <code>mobile.12306.cn</code> 这样的404报错。后来通过实践，通过正确设置nginx的listen的值，可以有效规避这问题。</p>
<h4 id="什么是恶意域名解析？"><a href="#什么是恶意域名解析？" class="headerlink" title="什么是恶意域名解析？"></a>什么是恶意域名解析？</h4><p>因为IP地址不方便记忆，我们通常上网一般都是通过域名发出请求，通过DNS系统来转换成具体IP地址。<br>当然，也可以更改客户端的hosts文件（优先级比DNS更高）, 于是也有攻击者，把其他网站域名和被攻击IP关联，比如：<br><code>120.79.66.66 www.abc.com</code>，最终，从这台电脑上发出到<a href="http://www.abc.com任意请求都会被解析到120.79.66.66上。">www.abc.com任意请求都会被解析到120.79.66.66上。</a></p>
<p>最终导致带宽被占满，正常服务受影响。</p>
<a id="more"></a>


<h4 id="nginx的listen设置"><a href="#nginx的listen设置" class="headerlink" title="nginx的listen设置"></a>nginx的listen设置</h4><p>关于listen中的default_server，官网是这样解释的：<code>The default_server parameter, if present, will cause the server to become the default server for the specified address:port pair. If none of the directives have the default_server parameter then the first server with the address:port pair will be the default server for this pair.</code> 也就是说，如果设置了default_server，可以配合<code>server_name _</code> （匹配没找到有效的server_name）</p>
<p>下方配置放在nginx配置文件的最后，当请求$host没有在nginx中匹配到时，交给default_server，最后返回444状态码（不返回信息，直接关闭连接）</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>      <span class="number">80</span> default_server;</span><br><span class="line">        <span class="attribute">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line">        <span class="attribute">server_name</span>  _;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">444</span>;</span><br><span class="line">        <span class="attribute">access_log</span> /var/log/opsping.com_deny.log;</span><br><span class="line">        <span class="attribute">error_log</span> /var/log/opsping.com_deny.log;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>      <span class="number">443</span> http2 default_server;</span><br><span class="line">        <span class="attribute">listen</span> [::]:<span class="number">443</span> http2 default_server;</span><br><span class="line">        <span class="attribute">server_name</span>  _;</span><br><span class="line">        <span class="attribute">ssl_certificate</span> <span class="string">"ssl/3635348_opsping.com.pem"</span>;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> <span class="string">"ssl/3635348_opsping.com.key"</span>;</span><br><span class="line">        <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">1m</span>;</span><br><span class="line">        <span class="attribute">ssl_session_timeout</span>  <span class="number">10m</span>;</span><br><span class="line">        <span class="attribute">ssl_ciphers</span> ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">444</span>;</span><br><span class="line">        <span class="attribute">access_log</span> /var/log/opsping.com_deny.log;</span><br><span class="line">        <span class="attribute">error_log</span> /var/log/opsping.com_deny.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="实际效果"><a href="#实际效果" class="headerlink" title="实际效果"></a>实际效果</h4><p>reload nginx后，访问<a href="http://www.abc.com可以在访问日志中看到，请求已经被关闭">http://www.abc.com可以在访问日志中看到，请求已经被关闭</a><br><code># tail -f /var/log/opsping.com_deny.log</code> </p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="number">113.87.227.235</span> - - <span class="string">[21/Mar/2020:14:07:43 +0800]</span> <span class="string">"<span class="keyword">GET</span> /favicon.ico HTTP/1.1"</span> <span class="number">444</span> <span class="number">0</span> <span class="string">"http://www.abc.com/"</span> <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36"</span></span><br><span class="line"><span class="number">80.82.70.187</span> - - <span class="string">[21/Mar/2020:16:52:35 +0800]</span> <span class="string">"<span class="keyword">GET</span> http://www.baidu.com/cache/global/img/gs.gif HTTP/1.1"</span> <span class="number">444</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"Mozilla"</span></span><br><span class="line"><span class="number">80.82.70.187</span> - - <span class="string">[21/Mar/2020:16:52:37 +0800]</span> <span class="string">"<span class="keyword">GET</span> http://www.baidu.com/cache/global/img/gs.gif HTTP/1.1"</span> <span class="number">444</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"Mozilla"</span></span><br><span class="line"><span class="number">139.162.88.63</span> - - <span class="string">[21/Mar/2020:17:16:14 +0800]</span> <span class="string">"<span class="keyword">GET</span> http://clientapi.ipip.net/echo.php?info=1234567890 HTTP/1.1"</span> <span class="number">444</span> <span class="number">0</span> <span class="string">"-"</span> <span class="string">"Go-http-client/1.1"</span></span><br></pre></td></tr></table></figure>

<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html">http://nginx.org/en/docs/http/ngx_http_core_module.html</a></p>
]]></content>
      <categories>
        <category>安全</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
</search>
